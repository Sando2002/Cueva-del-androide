{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Compras - Cueva del Androide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}?v=5.1" />
    <link rel="stylesheet" href="{% static 'css/mis_pedidos.css' %}?v=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Baloo+2:wght@800;900&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen flex flex-col">
    {% include 'includes/navbar.html' %}
    
    <div class="page-content">
        <div class="container-custom">
            <!-- Título -->
            <div class="title-section">
                <h1><i class="fas fa-box"></i> Mis Compras</h1>
                <p>Total de pedidos: {{ contadores.total }}</p>
            </div>
            
            <!-- Tabs de Estados -->
            <div class="tabs-container">
                <a href="?estado=todos" class="tab-btn {% if estado_filtro == 'todos' %}active{% endif %}" data-count="{{ contadores.total }}">
                    <i class="fas fa-boxes"></i> Todos
                </a>
                <a href="?estado=pendiente" class="tab-btn {% if estado_filtro == 'pendiente' %}active{% endif %}" data-count="{{ contadores.pendiente }}">
                    <i class="fas fa-clock"></i> Pendientes de Pago
                </a>
                <a href="?estado=en_preparacion" class="tab-btn {% if estado_filtro == 'en_preparacion' %}active{% endif %}" data-count="{{ contadores.en_preparacion }}">
                    <i class="fas fa-check-circle"></i> En Preparación
                </a>
                <a href="?estado=listo" class="tab-btn {% if estado_filtro == 'listo' %}active{% endif %}" data-count="{{ contadores.listo }}">
                    <i class="fas fa-hourglass-half"></i> Listos para Recoger
                </a>
                <a href="?estado=recogido" class="tab-btn {% if estado_filtro == 'recogido' %}active{% endif %}" data-count="{{ contadores.recogido }}">
                    <i class="fas fa-box-open"></i> Recogidos
                </a>
                <a href="?estado=rechazado" class="tab-btn {% if estado_filtro == 'rechazado' %}active{% endif %}" data-count="{{ contadores.rechazado }}">
                    <i class="fas fa-times-circle"></i> Rechazados
                </a>
                <a href="?estado=cancelado" class="tab-btn {% if estado_filtro == 'cancelado' %}active{% endif %}" data-count="{{ contadores.cancelado }}">
                    <i class="fas fa-ban"></i> Cancelados
                </a>
            </div>
            
            <!-- Lista de Pedidos -->
            {% if pedidos %}
                {% for pedido in pedidos %}
                <div class="pedido-card">
                    <!-- Header del Pedido -->
                    <div class="pedido-header">
                        <div style="flex: 1;">
                            <div class="pedido-numero">Pedido #{{ pedido.numero_pedido }}</div>
                            <div class="pedido-fecha">
                                <i class="fas fa-calendar"></i> {{ pedido.fecha_creacion|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        <div class="pedido-estado estado-{{ pedido.estado }}">
                            {% if pedido.estado == 'en_preparacion' %}
                                <i class="fas fa-check"></i> En Preparación
                            {% elif pedido.estado == 'listo' %}
                                <i class="fas fa-spinner"></i> Listo para Recoger
                            {% elif pedido.estado == 'recogido' %}
                                <i class="fas fa-box-open"></i> Recogido
                            {% elif pedido.estado == 'pendiente' %}
                                <i class="fas fa-clock"></i> Pendiente
                            {% elif pedido.estado == 'rechazado' %}
                                <i class="fas fa-times"></i> Rechazado
                            {% elif pedido.estado == 'cancelado' %}
                                <i class="fas fa-ban"></i> Cancelado
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Total y Acciones -->
                    <div class="pedido-acciones">
                        <div class="pedido-total">
                            Total: <strong>${{ pedido.total|add:0 }}</strong> CLP
                        </div>
                        <div class="acciones-botones">
                            {% if pedido.estado == 'pendiente' or pedido.estado == 'en_preparacion' %}
                                <form method="POST" action="{% url 'cancelar_pedido' pedido.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-accion-small btn-cancelar" onclick="return confirm('¿Estás seguro de que deseas cancelar este pedido?');">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                </form>
                            {% endif %}
                            {% if pedido.estado == 'pendiente' %}
                                <a href="{% url 'reintentar_pago' pedido.id %}" class="btn-accion-small btn-reintentar">
                                    <i class="fas fa-redo"></i> Reintentar Pago
                                </a>
                            {% endif %}
                            {% if pedido.estado == 'listo' %}
                                <button type="button" class="btn-accion-small btn-recogido" onclick="marcarComoRecogido({{ pedido.id }})">
                                    <i class="fas fa-box-open"></i> Marcar como Recogido
                                </button>
                            {% endif %}
                            <button type="button" class="btn-detalles" onclick="toggleDetalles({{ pedido.id }})">
                                <i class="fas fa-eye"></i> <span id="text-{{ pedido.id }}">Ver</span> Detalles
                            </button>
                        </div>
                    </div>
                    
                    <!-- Items del Pedido (Expandible) -->
                    {% if pedido.items.all %}
                    <div class="pedido-items-container" id="items-{{ pedido.id }}" style="display: none;">
                        <div class="pedido-items">
                            {% for item in pedido.items.all %}
                            <div class="item-producto">
                                <div class="item-nombre">
                                    <strong>{{ item.producto.titulo }}</strong>
                                </div>
                                <div class="item-cantidad">x{{ item.cantidad }}</div>
                                <div class="item-precio">${{ item.precio_unitario|add:0 }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="empty-text">
                        {% if estado_filtro == 'todos' %}
                            No tienes pedidos aún
                        {% else %}
                            No hay pedidos en esta categoría
                        {% endif %}
                    </div>
                    <a href="{% url 'catalogo' %}" class="btn-comprar">
                        <i class="fas fa-shopping-bag"></i> Ir a Comprar
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    {% include 'includes/footer.html' %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/cart.js' %}?v=1.0"></script>
    
    <script>
        // Toggle expandir/contraer detalles del pedido
        function toggleDetalles(pedidoId) {
            const itemsDiv = document.getElementById(`items-${pedidoId}`);
            const textSpan = document.getElementById(`text-${pedidoId}`);
            
            if (itemsDiv.style.display === 'none') {
                itemsDiv.style.display = 'block';
                textSpan.textContent = 'Ocultar';
            } else {
                itemsDiv.style.display = 'none';
                textSpan.textContent = 'Ver';
            }
        }
        
        // Marcar pedido como recogido
        function marcarComoRecogido(pedidoId) {
            if (confirm('¿Confirmás que recogiste este pedido?')) {
                fetch(`/pedido/${pedidoId}/marcar-recogido/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Mostrar alerta de éxito
                        alert(data.message);
                        // Recargar la página para actualizar estados
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al marcar pedido como recogido');
                });
            }
        }
    </script>
</body>
</html>
