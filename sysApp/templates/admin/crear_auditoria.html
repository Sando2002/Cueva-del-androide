{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}
<div class="container" style="padding: 2rem; max-width: 700px;">
    <div style="margin-bottom: 2rem;">
        <h2 style="font-size: 2rem; color: #2c3e50; margin-bottom: 0.5rem;">üîç Crear Auditor√≠a de Inventario</h2>
        <p style="color: #7f8c8d;">Inicia un nuevo conteo c√≠clico o por categor√≠a</p>
    </div>

    <div class="card" style="border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <div class="card-body" style="padding: 2rem;">
            <form method="post" style="display: grid; gap: 1.5rem;">
                {% csrf_token %}

                <!-- Tipo de Auditor√≠a -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Tipo de Auditor√≠a *
                    </label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="tipo" value="ciclico" required style="margin-right: 0.75rem; width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #2c3e50;">C√≠clica</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid #bdc3c7; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="tipo" value="categoria" required style="margin-right: 0.75rem; width: 20px; height: 20px; cursor: pointer;">
                            <span style="font-weight: 600; color: #2c3e50;">Por Categor√≠a</span>
                        </label>
                    </div>
                </div>

                <!-- Categor√≠a (condicional) -->
                <div id="categoria-container" style="display: none;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Categor√≠a a Auditar *
                    </label>
                    <select name="categoria_id" id="categoria_select" 
                            style="width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem;">
                        <option value="">-- Selecciona una categor√≠a --</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Info de la auditor√≠a -->
                <div style="padding: 1.5rem; background: #e8f8f5; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <div id="info-auditoria">
                        <small style="color: #16a085; display: block; margin-bottom: 0.5rem;">‚ÑπÔ∏è Informaci√≥n</small>
                        <p style="margin: 0; color: #27ae60; font-size: 0.95rem;">
                            Se iniciar√° una auditor√≠a c√≠clica del inventario. Los productos se marcar√°n como "en_proceso" y no se podr√°n vender hasta finalizar el conteo.
                        </p>
                    </div>
                </div>

                <!-- Descripci√≥n / Motivo -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Motivo / Descripci√≥n (opcional)
                    </label>
                    <textarea name="motivo" rows="3" placeholder="Ej: Auditor√≠a mensual de fin de periodo"
                              style="width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem; font-family: Arial;"></textarea>
                </div>

                <!-- Resumen de productos -->
                <div id="resumen-productos" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; display: none;">
                    <small style="color: #7f8c8d; display: block; margin-bottom: 0.5rem;">Productos a auditar:</small>
                    <h4 id="resumen-count" style="margin: 0; color: #2c3e50;"></h4>
                </div>

                <!-- Aviso importante -->
                <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; display: flex; gap: 1rem;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong style="color: #856404;">Importante:</strong>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #856404;">
                            Durante la auditor√≠a, los productos estar√°n <strong>bloqueados para venta</strong>. 
                            Aseg√∫rate de contar el inventario f√≠sico y compararlo con el sistema para ajustar discrepancias.
                        </p>
                    </div>
                </div>

                <!-- Botones -->
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1; padding: 0.75rem; font-weight: 600;">
                        <i class="bi bi-play-fill"></i> Iniciar Auditor√≠a
                    </button>
                    <a href="{% url 'gestionar_inventario' %}" class="btn btn-secondary" style="flex: 1; padding: 0.75rem; text-decoration: none; text-align: center;">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoRadios = document.querySelectorAll('input[name="tipo"]');
    const categoriaContainer = document.getElementById('categoria-container');
    const categoriaSelect = document.getElementById('categoria_select');
    const infoAuditoria = document.getElementById('info-auditoria');
    const resumenProductos = document.getElementById('resumen-productos');
    const resumenCount = document.getElementById('resumen-count');

    const productos = {
        ciclico: {{ total_productos }},
        categoria: {
            {% for categoria in categorias %}
            {{ categoria.id }}: {{ categoria.productos_count|default:0 }},
            {% endfor %}
        }
    };

    function actualizarInfo() {
        const tipoSeleccionado = document.querySelector('input[name="tipo"]:checked').value;
        
        if (tipoSeleccionado === 'ciclico') {
            categoriaContainer.style.display = 'none';
            categoriaSelect.removeAttribute('required');
            
            infoAuditoria.innerHTML = `
                <small style="color: #16a085; display: block; margin-bottom: 0.5rem;">‚ÑπÔ∏è Auditor√≠a C√≠clica</small>
                <p style="margin: 0; color: #27ae60; font-size: 0.95rem;">
                    Se auditar√°n <strong>${productos.ciclico} productos</strong> en total. Esta es una auditor√≠a completa del inventario.
                </p>
            `;
            
            resumenProductos.style.display = 'block';
            resumenCount.textContent = `Total: ${productos.ciclico} productos para contar`;
            
        } else if (tipoSeleccionado === 'categoria') {
            categoriaContainer.style.display = 'block';
            categoriaSelect.setAttribute('required', 'required');
            
            const categoriaSeleccionada = categoriaSelect.value;
            if (categoriaSeleccionada) {
                const count = productos.categoria[categoriaSeleccionada] || 0;
                infoAuditoria.innerHTML = `
                    <small style="color: #16a085; display: block; margin-bottom: 0.5rem;">‚ÑπÔ∏è Auditor√≠a por Categor√≠a</small>
                    <p style="margin: 0; color: #27ae60; font-size: 0.95rem;">
                        Se auditar√°n <strong>${count} productos</strong> de esta categor√≠a. Aseg√∫rate de verificar cada unidad.
                    </p>
                `;
                
                resumenProductos.style.display = 'block';
                resumenCount.textContent = `Total: ${count} productos en esta categor√≠a`;
            } else {
                infoAuditoria.innerHTML = `
                    <small style="color: #16a085; display: block; margin-bottom: 0.5rem;">‚ÑπÔ∏è Auditor√≠a por Categor√≠a</small>
                    <p style="margin: 0; color: #27ae60; font-size: 0.95rem;">
                        Selecciona una categor√≠a para ver cu√°ntos productos ser√°n auditados.
                    </p>
                `;
                resumenProductos.style.display = 'none';
            }
        }
    }

    tipoRadios.forEach(radio => {
        radio.addEventListener('change', actualizarInfo);
    });

    categoriaSelect.addEventListener('change', actualizarInfo);

    // Inicializar
    actualizarInfo();
});
</script>
{% endblock %}
