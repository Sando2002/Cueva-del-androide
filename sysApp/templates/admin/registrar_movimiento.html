{% extends 'admin/base_admin.html' %}
{% load static %}

{% block content %}
<div class="container" style="padding: 2rem; max-width: 600px;">
    <div style="margin-bottom: 2rem;">
        <h2 style="font-size: 2rem; color: #2c3e50; margin-bottom: 0.5rem;">üìù Registrar Movimiento</h2>
        <p style="color: #7f8c8d;">Producto: <strong>{{ producto.titulo }}</strong></p>
    </div>

    <div class="card" style="border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        <div class="card-body" style="padding: 2rem;">
            <!-- Info Stock Actual -->
            <div style="padding: 1rem; background: #ecf0f1; border-radius: 8px; margin-bottom: 2rem; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
                <div>
                    <small style="color: #7f8c8d;">Stock Actual</small>
                    <h3 style="margin: 0.5rem 0 0 0; color: #3498db;">{{ producto.stock }}</h3>
                </div>
                <div>
                    <small style="color: #7f8c8d;">Stock M√≠nimo</small>
                    <h3 style="margin: 0.5rem 0 0 0; color: #e74c3c;">{{ producto.stock_minimo }}</h3>
                </div>
                <div>
                    <small style="color: #7f8c8d;">Stock M√°ximo</small>
                    <h3 style="margin: 0.5rem 0 0 0; color: #27ae60;">{{ producto.stock_maximo }}</h3>
                </div>
            </div>

            <form method="post" style="display: grid; gap: 1.5rem;">
                {% csrf_token %}

                <!-- Tipo de Movimiento -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Tipo de Movimiento
                    </label>
                    <select name="tipo" required style="width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem;">
                        <option value="">-- Selecciona un tipo --</option>
                        {% for valor, etiqueta in tipos_movimiento %}
                        <option value="{{ valor }}">{{ etiqueta }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Cantidad -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Cantidad
                    </label>
                    <input type="number" name="cantidad" required min="1" style="width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem;">
                </div>

                <!-- Motivo -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2c3e50;">
                        Motivo (opcional)
                    </label>
                    <textarea name="motivo" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 1rem; font-family: Arial;"></textarea>
                </div>

                <!-- Preview -->
                <div style="padding: 1rem; background: #d5f4e6; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <small style="color: #16a085; display: block; margin-bottom: 0.5rem;">Vista previa del resultado:</small>
                    <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center;">
                        <span style="font-weight: 700; color: #2c3e50;">{{ producto.stock }}</span>
                        <span id="operador" style="text-align: center; color: #95a5a6;">+</span>
                        <span id="cantidad-preview" style="font-weight: 700; color: #2c3e50;">0</span>
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem; color: #27ae60; font-weight: 700;">
                        = <span id="resultado" style="font-size: 1.2rem;">{{ producto.stock }}</span>
                    </div>
                </div>

                <!-- Botones -->
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1; padding: 0.75rem;">
                        <i class="bi bi-check-circle"></i> Confirmar Movimiento
                    </button>
                    <a href="{% url 'gestionar_inventario' %}" class="btn btn-secondary" style="flex: 1; padding: 0.75rem; text-decoration: none; text-align: center;">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.querySelector('select[name="tipo"]');
    const cantidadInput = document.querySelector('input[name="cantidad"]');
    const operadorSpan = document.getElementById('operador');
    const cantidadPreview = document.getElementById('cantidad-preview');
    const resultadoSpan = document.getElementById('resultado');
    const stockActual = {{ producto.stock }};

    function actualizarPreview() {
        const tipo = tipoSelect.value;
        const cantidad = parseInt(cantidadInput.value) || 0;
        
        if (tipo.includes('entrada')) {
            operadorSpan.textContent = '+';
            cantidadPreview.textContent = cantidad;
            resultadoSpan.textContent = stockActual + cantidad;
        } else if (tipo.includes('salida') || tipo === 'ajuste') {
            if (tipo === 'ajuste') {
                operadorSpan.textContent = '‚Üí';
                resultadoSpan.textContent = cantidad;
                cantidadPreview.textContent = '';
            } else {
                operadorSpan.textContent = '‚àí';
                cantidadPreview.textContent = cantidad;
                resultadoSpan.textContent = stockActual - cantidad;
            }
        } else {
            cantidadPreview.textContent = '0';
            resultadoSpan.textContent = stockActual;
        }
    }

    tipoSelect.addEventListener('change', actualizarPreview);
    cantidadInput.addEventListener('input', actualizarPreview);
});
</script>
{% endblock %}
